<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Flower Liner WebAR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    html,body{
      margin:0;
      height:100%;
      overflow:hidden;
      background:transparent;
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
    }
    #gate{
      position:fixed;inset:0;
      background:rgba(0,0,0,.85);color:#fff;
      display:flex;flex-direction:column;gap:14px;
      align-items:center;justify-content:center;
      z-index:20;
    }
    #gate button{
      padding:12px 18px;border-radius:14px;border:none;
      background:#29b6f6;color:#012;font-weight:600;font-size:16px;
    }
    #mode{
      position:fixed;top:10px;left:10px;
      background:rgba(0,0,0,.5);color:#fff;
      padding:4px 8px;border-radius:10px;font-size:12px;z-index:15;
    }
    #msg{
      position:fixed;top:10px;left:50%;transform:translateX(-50%);
      background:rgba(0,0,0,.5);color:#fff;
      padding:5px 10px;border-radius:10px;font-size:13px;z-index:15;
    }
    #ui{
      position:fixed;left:0;right:0;bottom:0;
      display:none;gap:10px;justify-content:center;flex-wrap:wrap;
      padding:12px 12px 20px;
      z-index:15;
    }
    .btn{
      -webkit-tap-highlight-color: transparent;
      padding:10px 14px;min-width:80px;
      border-radius:14px;border:none;
      background:rgba(255,255,255,.9);
      font-size:15px;
    }
  </style>
</head>
<body>
  <!-- èµ·å‹•æ™‚ã®è¨±å¯ç”»é¢ -->
  <div id="gate">
    <div>ğŸ”Š ã¯ã˜ã‚ã«ã‚¿ãƒƒãƒ—ã—ã¦ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„</div>
    <button id="startBtn">é–‹å§‹ã™ã‚‹</button>
    <div style="opacity:.7;font-size:13px">iPhoneã¯ãƒãƒ¼ã‚«ãƒ¼ARã€Androidãªã©å¯¾å¿œç«¯æœ«ã¯å¹³é¢æ¤œå‡ºARã‚’ä½¿ã„ã¾ã™ã€‚</div>
  </div>

  <!-- çŠ¶æ…‹è¡¨ç¤º -->
  <div id="mode">mode: -</div>
  <div id="msg">æº–å‚™ä¸­â€¦</div>

  <!-- ä¸‹éƒ¨ã®æ“ä½œUIï¼ˆãƒ¢ãƒ‡ãƒ«ã‚’ç½®ã„ãŸå¾Œã«ä½¿ã†ï¼‰ -->
  <div id="ui">
    <button class="btn" id="btnF">å‰é€²</button>
    <button class="btn" id="btnB">å¾Œé€²</button>
    <button class="btn" id="btnL">å·¦æŠ˜</button>
    <button class="btn" id="btnR">å³æŠ˜</button>
  </div>

<script type="module">
/* =========================================================
   ç«¯æœ«åˆ¤å®š
   ========================================================= */
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

const startBtn = document.getElementById('startBtn');
const gateEl   = document.getElementById('gate');
const modeEl   = document.getElementById('mode');
const msgEl    = document.getElementById('msg');
const uiEl     = document.getElementById('ui');

startBtn.addEventListener('click', async () => {
  gateEl.style.display = 'none';
  if (isIOS) {
    // iOS ã¯ AR.js ãƒãƒ¼ã‚«ãƒ¼ã«å¼·åˆ¶
    modeEl.textContent = 'mode: Marker AR (iOS)';
    startMarkerAR();
  } else {
    // Android ãªã© â†’ WebXR
    modeEl.textContent = 'mode: WebXR (plane hit-test)';
    startWebXR();
  }
});

/* =========================================================
   WebXR ãƒ«ãƒ¼ãƒˆï¼ˆAndroid / å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ï¼‰
   three.js ã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ä½¿ã„ã¾ã™
   ========================================================= */
async function startWebXR(){
  msgEl.textContent = 'åºŠã‚’æ¢ã—ã¦ã„ã¾ã™â€¦';
  uiEl.style.display = 'flex';

  const [
    {default: THREE},
    {ARButton},
    {GLTFLoader}
  ] = await Promise.all([
    import('https://unpkg.com/three@0.159.0/build/three.module.js'),
    import('https://unpkg.com/three@0.159.0/examples/jsm/webxr/ARButton.js'),
    import('https://unpkg.com/three@0.159.0/examples/jsm/loaders/GLTFLoader.js')
  ]);

  const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  renderer.setPixelRatio(devicePixelRatio);
  renderer.setSize(innerWidth, innerHeight);
  renderer.xr.enabled = true;
  renderer.setClearAlpha(0); // ã‚«ãƒ¡ãƒ©ã‚’é€ã‹ã™
  document.body.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera();
  scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1));

  // ãƒ’ãƒƒãƒˆä½ç½®ã‚’ç¤ºã™ãƒªãƒ³ã‚°
  const reticle = new THREE.Mesh(
    new THREE.RingGeometry(0.08, 0.12, 32).rotateX(-Math.PI/2),
    new THREE.MeshBasicMaterial({color:0x00ff99})
  );
  reticle.matrixAutoUpdate = false;
  reticle.visible = false;
  scene.add(reticle);

  // å®Ÿéš›ã®ARãƒœã‚¿ãƒ³ã¯éš ã™
  const realBtn = ARButton.createButton(renderer, {
    requiredFeatures: ['hit-test']
  });
  realBtn.style.display = 'none';
  document.body.appendChild(realBtn);
  // ä»£ã‚ã‚Šã«èµ·å‹•æ™‚ã«è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚‚ã†startBtnã¯æ¶ˆãˆã¦ã‚‹ã®ã§OKï¼‰
  realBtn.click();

  // ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿
  let train = null;
  const loader = new GLTFLoader();
  loader.load('./AR-Train_Nagai.glb', (gltf)=>{
    train = gltf.scene;
    train.visible = false;
    scene.add(train);
  });

  // ãƒ’ãƒƒãƒˆãƒ†ã‚¹ãƒˆç”¨
  let hitSource = null;
  let hitSourceRequested = false;

  // ãƒœã‚¿ãƒ³ã«ã‚ˆã‚‹ç§»å‹•åˆ¶å¾¡
  let mvF=false,mvB=false,mvL=false,mvR=false;
  const hold = (el,on,off)=>{
    el.addEventListener('pointerdown', on);
    el.addEventListener('pointerup', off);
    el.addEventListener('pointerleave', off);
    el.addEventListener('touchend', off, {passive:true});
  };
  hold(document.getElementById('btnF'), ()=>mvF=true, ()=>mvF=false);
  hold(document.getElementById('btnB'), ()=>mvB=true, ()=>mvB=false);
  hold(document.getElementById('btnL'), ()=>mvL=true, ()=>mvL=false);
  hold(document.getElementById('btnR'), ()=>mvR=true, ()=>mvR=false);

  const clock = new THREE.Clock();

  renderer.setAnimationLoop((t, frame)=>{
    const dt = clock.getDelta();

    // åˆå›ã«ãƒ’ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å–å¾—
    const session = renderer.xr.getSession();
    if (session && !hitSourceRequested) {
      session.requestReferenceSpace('viewer').then(refSpace=>{
        session.requestHitTestSource({space:refSpace}).then(src=>{
          hitSource = src;
        });
      });
      session.addEventListener('end', ()=>{
        hitSourceRequested = false;
        hitSource = null;
      });
      hitSourceRequested = true;
    }

    // æ¯ãƒ•ãƒ¬ãƒ¼ãƒ åºŠã‚’æ¢ã™
    if (frame && hitSource) {
      const refSpace = renderer.xr.getReferenceSpace();
      const hits = frame.getHitTestResults(hitSource);
      if (hits.length) {
        const hit = hits[0];
        const pose = hit.getPose(refSpace);
        reticle.visible = true;
        reticle.matrix.fromArray(pose.transform.matrix);

        // ã‚¿ãƒƒãƒ—ã§åˆ—è»Šã‚’ãã®ä½ç½®ã«ç½®ã
        renderer.domElement.onclick = ()=>{
          if (train) {
            train.visible = true;
            train.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
            train.quaternion.set(
              pose.transform.orientation.x,
              pose.transform.orientation.y,
              pose.transform.orientation.z,
              pose.transform.orientation.w
            );
          }
        };

        msgEl.style.display = 'none';
      } else {
        reticle.visible = false;
        msgEl.style.display = 'block';
        msgEl.textContent = 'åºŠã‚’æ¢ã—ã¦ã„ã¾ã™â€¦';
      }
    }

    // åˆ—è»Šã®ç§»å‹•
    if (train && train.visible) {
      if (mvF) train.translateZ(-1.2 * dt);
      if (mvB) train.translateZ( 1.2 * dt);
      if (mvL) train.rotateY( 1.5 * dt);
      if (mvR) train.rotateY(-1.5 * dt);
    }

    renderer.render(scene, camera);
  });

  addEventListener('resize', ()=>{
    renderer.setSize(innerWidth, innerHeight);
  });
}

/* =========================================================
   iOSç”¨ AR.js ãƒ«ãƒ¼ãƒˆ
   ========================================================= */
async function startMarkerAR(){
  // iOSã¯å‹•çš„ãƒ­ãƒ¼ãƒ‰ã ã¨ã“ã‘ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€ã“ã®é †ç•ªã§èª­ã‚€
  const s1 = document.createElement('script');
  s1.src = 'https://aframe.io/releases/1.4.2/aframe.min.js';
  document.head.appendChild(s1);
  await new Promise(r=>s1.onload=r);

  const s2 = document.createElement('script');
  s2.src = 'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js';
  document.head.appendChild(s2);
  await new Promise(r=>s2.onload=r);

  // A-Frameã‚·ãƒ¼ãƒ³ã‚’DOMã«æŒ¿å…¥
  document.body.insertAdjacentHTML('beforeend', `
    <a-scene
      embedded
      vr-mode-ui="enabled:false"
      renderer="alpha:true; colorManagement:true"
      arjs="sourceType: webcam; debugUIEnabled:false;">
      <a-assets>
        <a-asset-item id="trainModel" src="AR-Train_Nagai.glb"></a-asset-item>
      </a-assets>

      <a-marker type="pattern" url="pattern-hiro.patt">
        <a-entity id="trainRig">
          <a-gltf-model src="#trainModel" scale="1 1 1" position="0 0 0"></a-gltf-model>
        </a-entity>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>
  `);

  // ä¸‹ã®ãƒœã‚¿ãƒ³ã§ rig ã‚’å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
  uiEl.style.display = 'flex';
  msgEl.textContent = 'ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚«ãƒ¡ãƒ©ã«æ˜ ã—ã¦ãã ã•ã„';

  const rigMove = {F:false,B:false,L:false,R:false};
  const hold = (id,on,off)=>{
    const el = document.getElementById(id);
    el.addEventListener('pointerdown', on);
    el.addEventListener('pointerup', off);
    el.addEventListener('pointerleave', off);
    el.addEventListener('touchend', off, {passive:true});
  };
  hold('btnF', ()=>rigMove.F=true, ()=>rigMove.F=false);
  hold('btnB', ()=>rigMove.B=true, ()=>rigMove.B=false);
  hold('btnL', ()=>rigMove.L=true, ()=>rigMove.L=false);
  hold('btnR', ()=>rigMove.R=true, ()=>rigMove.R=false);

  function loop(){
    const rig = document.getElementById('trainRig');
    if (rig && rig.object3D){
      if (rigMove.F) rig.object3D.translateZ(-0.02);
      if (rigMove.B) rig.object3D.translateZ( 0.02);
      if (rigMove.L) rig.object3D.rotation.y += 0.02;
      if (rigMove.R) rig.object3D.rotation.y -= 0.02;
    }
    requestAnimationFrame(loop);
  }
  loop();
}
</script>
</body>
</html>
