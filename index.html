<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Flower Liner WebAR (Safe Dual Mode)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,-apple-system;}
    #startScreen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:#000;color:#fff;z-index:50;}
    button{padding:10px 18px;border:none;border-radius:14px;background:#29b6f6;color:#012;font-size:16px;font-weight:600;}
    #ios-cam{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;display:none;background:#000;}
    #ui{
      position:fixed;left:0;right:0;bottom:0;
      display:none;gap:6px;flex-wrap:wrap;justify-content:center;
      background:rgba(0,0,0,.35);padding:10px;z-index:20;
    }
    .btn{padding:6px 10px;border:none;border-radius:10px;background:rgba(255,255,255,.9);font-size:13px;}
  </style>
</head>
<body>
  <div id="startScreen">
    <h1>フラワー長井線 WebAR</h1>
    <button id="startBtn">開始する</button>
    <p>iPhoneはカメラ背景・Androidは床検出で動作します。</p>
  </div>
  <video id="ios-cam" autoplay playsinline muted></video>
  <div id="ui">
    <button class="btn" data-act="up">↑</button>
    <button class="btn" data-act="down">↓</button>
    <button class="btn" data-act="left">←</button>
    <button class="btn" data-act="right">→</button>
    <button class="btn" data-act="near">手前</button>
    <button class="btn" data-act="far">奥</button>
    <button class="btn" data-act="rotL">⟲</button>
    <button class="btn" data-act="rotR">⟳</button>
  </div>

<script type="module">
import * as THREE from "https://unpkg.com/three@0.159.0/build/three.module.js";
import {GLTFLoader} from "https://unpkg.com/three@0.159.0/examples/jsm/loaders/GLTFLoader.js";
import {ARButton} from "https://unpkg.com/three@0.159.0/examples/jsm/webxr/ARButton.js";

const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
const startBtn = document.getElementById('startBtn');
startBtn.addEventListener('click', ()=>{ document.getElementById('startScreen').remove(); isIOS ? startIOS() : startXR(); });

/* ---------- iOSモード ---------- */
async function startIOS(){
  const video = document.getElementById('ios-cam');
  const ui = document.getElementById('ui');
  video.style.display = 'block';
  ui.style.display = 'flex';

  // カメラ背景
  try {
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject = stream;
  } catch(e){ alert('カメラが使用できません'); }

  // Three.js 初期化
  const renderer = new THREE.WebGLRenderer({alpha:true, antialias:true});
  renderer.setSize(innerWidth, innerHeight);
  renderer.domElement.style.position="fixed";
  renderer.domElement.style.inset=0;
  renderer.domElement.style.pointerEvents="none"; // UIが押せるように
  document.body.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.01, 100);
  camera.position.set(0,0,5);
  scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));

  const loader = new GLTFLoader();
  let train = null;
  loader.load("./AR-Train_Nagai.glb", gltf=>{
    train = gltf.scene;
    train.scale.set(0.3,0.3,0.3);
    train
