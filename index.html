<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Flower Liner WebAR (dual)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,-apple-system;}
    #gate{
      position:fixed;inset:0;background:rgba(0,0,0,.85);color:#fff;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;z-index:50;
    }
    #gate button{padding:12px 16px;border:none;border-radius:14px;background:#29b6f6;color:#012;font-size:16px;font-weight:600}
    #mode{position:fixed;top:10px;left:10px;background:rgba(0,0,0,.4);color:#fff;padding:4px 8px;border-radius:10px;font-size:12px;z-index:30}
    #msg{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.4);color:#fff;padding:5px 10px;border-radius:10px;z-index:30;font-size:13px}
    /* iOS ç°¡æ˜“ç‰ˆã®ãƒœã‚¿ãƒ³ */
    #ios-ui{
      position:fixed;left:0;right:0;bottom:0;
      display:none;gap:6px;flex-wrap:wrap;justify-content:center;
      background:rgba(0,0,0,.35);padding:10px;z-index:40;
    }
    .btn{padding:6px 10px;border:none;border-radius:10px;background:rgba(255,255,255,.9);font-size:13px}
    /* Android/WebXRç‰ˆã®ãƒœã‚¿ãƒ³ */
    #xr-ui{
      position:fixed;left:0;right:0;bottom:0;
      display:none;gap:10px;justify-content:center;flex-wrap:wrap;
      padding:12px 12px 16px;z-index:40;
    }
    #xr-ui .btn{min-width:80px}
    /* iOSã®ã‚«ãƒ¡ãƒ©æ˜ åƒ */
    #ios-cam{
      position:fixed;inset:0;width:100%;height:100%;object-fit:cover;background:#000;display:none;
    }
  </style>
</head>
<body>
  <div id="gate">
    <div>ğŸ”Š ã¯ã˜ã‚ã«ã‚¿ãƒƒãƒ—ã—ã¦ã‚«ãƒ¡ãƒ©ãƒ»ARã‚’é–‹å§‹ã—ã¾ã™</div>
    <button id="startBtn">é–‹å§‹ã™ã‚‹</button>
    <div style="opacity:.7;font-size:13px">Androidã¯å¹³é¢æ¤œå‡ºARã€iOSã¯ç”»é¢ä¸Šã§ä½ç½®èª¿æ•´ã™ã‚‹ç°¡æ˜“ARã«ãªã‚Šã¾ã™ã€‚</div>
  </div>
  <div id="mode">mode: --</div>
  <div id="msg">æº–å‚™ä¸­â€¦</div>

  <!-- iOSã‚«ãƒ¡ãƒ©èƒŒæ™¯ -->
  <video id="ios-cam" autoplay playsinline muted></video>

  <!-- iOSç”¨ UI -->
  <div id="ios-ui">
    <button class="btn" data-act="up">â†‘ ä¸Šã¸</button>
    <button class="btn" data-act="down">â†“ ä¸‹ã¸</button>
    <button class="btn" data-act="left">â† å·¦ã¸</button>
    <button class="btn" data-act="right">â†’ å³ã¸</button>
    <button class="btn" data-act="near">æ‰‹å‰</button>
    <button class="btn" data-act="far">å¥¥</button>
    <button class="btn" data-act="bigger">ï¼‹å¤§</button>
    <button class="btn" data-act="smaller">ï¼å°</button>
    <button class="btn" data-act="rotL">âŸ²</button>
    <button class="btn" data-act="rotR">âŸ³</button>
  </div>

  <!-- Android/WebXRç”¨ UI -->
  <div id="xr-ui">
    <button class="btn" id="btnF">å‰é€²</button>
    <button class="btn" id="btnB">å¾Œé€²</button>
    <button class="btn" id="btnL">å·¦æŠ˜</button>
    <button class="btn" id="btnR">å³æŠ˜</button>
  </div>

<script type="module">
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
const startBtn = document.getElementById('startBtn');
const gateEl = document.getElementById('gate');
const modeEl = document.getElementById('mode');
const msgEl = document.getElementById('msg');

startBtn.addEventListener('click', () => {
  gateEl.style.display = 'none';
  if (isIOS) {
    modeEl.textContent = 'mode: iOS overlay';
    startIOSOverlay();
  } else {
    modeEl.textContent = 'mode: WebXR (hit-test)';
    startWebXR();
  }
});

/* ============ iOS: ã‚«ãƒ¡ãƒ©èƒŒæ™¯ï¼‹UIã§ä½ç½®èª¿æ•´ ============ */
async function startIOSOverlay(){
  const cam = document.getElementById('ios-cam');
  const iosUI = document.getElementById('ios-ui');
  cam.style.display = 'block';
  iosUI.style.display = 'flex';

  // ã‚«ãƒ¡ãƒ©èµ·å‹•
  try {
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    cam.srcObject = stream;
    msgEl.textContent = 'ä½ç½®ã‚’ãƒœã‚¿ãƒ³ã§èª¿æ•´ã—ã¦ãã ã•ã„';
  } catch (e) {
    console.warn(e);
    msgEl.textContent = 'ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã¾ã›ã‚“ã§ã—ãŸ';
  }

  // three.js ã§é€æ˜ã‚­ãƒ£ãƒ³ãƒã‚¹
  const {default: THREE} = await import("https://unpkg.com/three@0.159.0/build/three.module.js");
  const {GLTFLoader} = await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/GLTFLoader.js");

  const renderer = new THREE.WebGLRenderer({alpha:true, antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.domElement.style.position = "fixed";
  renderer.domElement.style.inset = 0;
  renderer.domElement.style.pointerEvents = "none";
  document.body.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.01, 100);
  camera.position.set(0,0,5);
  scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1));

  let train = null;
  const loader = new GLTFLoader();
  loader.load("./AR-Train_Nagai.glb", (gltf)=>{
    train = gltf.scene;
    train.position.set(0, -0.5, 0);
    train.scale.set(0.5,0.5,0.5);
    scene.add(train);
  }, undefined, (err)=>console.error(err));

  const state = {x:0, y:-0.5, z:0, scale:0.5, rotY:0};

  iosUI.addEventListener('click', (e)=>{
    const act = e.target.dataset.act;
    if(!act) return;
    const step = 0.1;
    switch(act){
      case 'up': state.y += step; break;
      case 'down': state.y -= step; break;
      case 'left': state.x -= step; break;
      case 'right': state.x += step; break;
      case 'near': state.z += step; break;
      case 'far': state.z -= step; break;
      case 'bigger': state.scale *= 1.1; break;
      case 'smaller': state.scale /= 1.1; break;
      case 'rotL': state.rotY += 0.1; break;
      case 'rotR': state.rotY -= 0.1; break;
    }
  });

  function animate(){
    requestAnimationFrame(animate);
    if(train){
      train.position.set(state.x, state.y, state.z);
      train.scale.set(state.scale, state.scale, state.scale);
      train.rotation.y = state.rotY;
    }
    renderer.render(scene, camera);
  }
  animate();

  window.addEventListener('resize', ()=>{
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
  });
}

/* ============ Android/WebXR: åºŠæ¤œå‡ºã—ã¦é…ç½® ============ */
async function startWebXR(){
  const [{default: THREE}, {ARButton}, {GLTFLoader}] = await Promise.all([
    import('https://unpkg.com/three@0.159.0/build/three.module.js'),
    import('https://unpkg.com/three@0.159.0/examples/jsm/webxr/ARButton.js'),
    import('https://unpkg.com/three@0.159.0/examples/jsm/loaders/GLTFLoader.js')
  ]);

  const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.xr.enabled = true;
  renderer.setClearAlpha(0);
  document.body.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera();
  scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));

  const xrUI = document.getElementById('xr-ui');
  xrUI.style.display = 'flex';

  // reticle
  const reticle = new THREE.Mesh(
    new THREE.RingGeometry(0.08,0.12,32).rotateX(-Math.PI/2),
    new THREE.MeshBasicMaterial({color:0x00ff99})
  );
  reticle.matrixAutoUpdate = false;
  reticle.visible = false;
  scene.add(reticle);

  // ARãƒœã‚¿ãƒ³ï¼ˆéš ã™ï¼‰
  const realBtn = ARButton.createButton(renderer, {requiredFeatures:['hit-test']});
  realBtn.style.display = 'none';
  document.body.appendChild(realBtn);
  realBtn.click();

  // ãƒ¢ãƒ‡ãƒ«
  let train = null;
  const loader = new GLTFLoader();
  loader.load('./AR-Train_Nagai.glb', (gltf)=>{
    train = gltf.scene;
    train.visible = false;
    scene.add(train);
  });

  let hitSource = null;
  let hitSourceRequested = false;

  // UIç§»å‹•
  let mvF=false,mvB=false,mvL=false,mvR=false;
  const hold=(id,on,off)=>{
    const el=document.getElementById(id);
    el.addEventListener('pointerdown', on);
    el.addEventListener('pointerup', off);
    el.addEventListener('pointerleave', off);
    el.addEventListener('touchend', off, {passive:true});
  };
  hold('btnF', ()=>mvF=true, ()=>mvF=false);
  hold('btnB', ()=>mvB=true, ()=>mvB=false);
  hold('btnL', ()=>mvL=true, ()=>mvL=false);
  hold('btnR', ()=>mvR=true, ()=>mvR=false);

  const clock = new THREE.Clock();

  renderer.setAnimationLoop((t, frame)=>{
    const dt = clock.getDelta();

    const session = renderer.xr.getSession();
    if (session && !hitSourceRequested){
      session.requestReferenceSpace('viewer').then((refSpace)=>{
        session.requestHitTestSource({space:refSpace}).then((source)=>{
          hitSource = source;
        });
      });
      session.addEventListener('end', ()=>{
        hitSourceRequested = false;
        hitSource = null;
      });
      hitSourceRequested = true;
    }

    if (frame && hitSource){
      const refSpace = renderer.xr.getReferenceSpace();
      const hits = frame.getHitTestResults(hitSource);
      if (hits.length){
        const pose = hits[0].getPose(refSpace);
        reticle.visible = true;
        reticle.matrix.fromArray(pose.transform.matrix);
        msgEl.style.display = 'none';

        renderer.domElement.onclick = ()=>{
          if (train){
            train.visible = true;
            train.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
            train.quaternion.set(
              pose.transform.orientation.x,
              pose.transform.orientation.y,
              pose.transform.orientation.z,
              pose.transform.orientation.w
            );
          }
        };
      } else {
        reticle.visible = false;
        msgEl.style.display = 'block';
        msgEl.textContent = 'åºŠã‚’æ¢ã—ã¦ã„ã¾ã™â€¦';
      }
    }

    if (train && train.visible){
      if (mvF) train.translateZ(-1.2*dt);
      if (mvB) train.translateZ( 1.2*dt);
      if (mvL) train.rotateY( 1.5*dt);
      if (mvR) train.rotateY(-1.5*dt);
    }

    renderer.render(scene, camera);
  });

  window.addEventListener('resize', ()=>{
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
}
</script>
</body>
</html>
