<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Flower Liner WebAR - debug</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,sans-serif;}
    #startScreen{
      position:fixed;inset:0;display:flex;flex-direction:column;gap:10px;
      align-items:center;justify-content:center;background:rgba(0,0,0,.9);z-index:9999;
      text-align:center;
    }
    #startBtn{
      background:#29b6f6;color:#012;border:none;border-radius:14px;
      padding:12px 24px;font-size:18px;font-weight:600;touch-action:manipulation;
    }
    #status{
      position:fixed;top:10px;left:50%;transform:translateX(-50%);
      background:rgba(0,0,0,.55);padding:6px 10px;border-radius:10px;
      font-size:13px;z-index:5000;white-space:pre-line;max-width:90vw;
    }
    #cam{
      position:fixed;inset:0;width:100%;height:100%;object-fit:cover;
      display:none;background:#000;
    }
  </style>
</head>
<body>
  <div id="startScreen">
    <h1>フラワー長井線 WebAR</h1>
    <button id="startBtn" ontouchstart="">開始する</button>
    <p style="opacity:.7;font-size:13px">タップ後、カメラと3Dを読み込みます</p>
  </div>
  <video id="cam" autoplay playsinline muted></video>
  <div id="status" style="display:none;">待機中…</div>

<script type="module">
const startScreen = document.getElementById('startScreen');
const startBtn    = document.getElementById('startBtn');
const statusEl    = document.getElementById('status');
const video       = document.getElementById('cam');

startBtn.addEventListener('click', start, {passive:false});
startBtn.addEventListener('touchstart', start, {passive:false});

async function start(ev){
  ev.preventDefault();
  startScreen.style.display = 'none';
  statusEl.style.display = 'block';
  setStatus('開始しました');

  // 1) カメラ
  try {
    setStatus('カメラ起動中…');
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject = stream;
    video.style.display = 'block';
    setStatus('カメラOK ✅\n3Dを読み込みます…');
  } catch(e){
    setStatus('カメラの取得に失敗しました ❌\n' + e.name + ': ' + e.message);
    return;
  }

  // 2) three.jsを動的に読む（ここで失敗していた可能性が高い）
  let THREE, GLTFLoader;
  try {
    const threeMod = await import('https://unpkg.com/three@0.159.0/build/three.module.js');
    const gltfMod  = await import('https://unpkg.com/three@0.159.0/examples/jsm/loaders/GLTFLoader.js');
    THREE = threeMod;
    GLTFLoader = gltfMod.GLTFLoader;
    setStatus('three.js 読み込みOK ✅\nモデルを読み込みます…');
  } catch(e){
    setStatus('three.js の読み込みに失敗しました ❌\n' + e.message);
    return;
  }

  // 3) three.js 初期化
  const renderer = new THREE.WebGLRenderer({alpha:true, antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.domElement.style.position = 'fixed';
  renderer.domElement.style.inset = 0;
  renderer.domElement.style.pointerEvents = 'none';
  document.body.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.01, 100);
  camera.position.set(0,0,5);
  scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1));

  // 4) モデル読み込み
  let train = null;
  try {
    const loader = new GLTFLoader();
    loader.load(
      './AR-Train_Nagai.glb',
      (gltf)=>{
        train = gltf.scene;
        scene.add(train);
        autoFit(train, camera, renderer, 0.8);
        train.position.y -= 0.3;
        setStatus('モデル読み込みOK ✅\n下のモデルを動かしてください');
      },
      undefined,
      (err)=>{
        setStatus('GLBを読み込めませんでした ❌\n' + err.message);
      }
    );
  } catch(e){
    setStatus('GLBローダーでエラー ❌\n' + e.message);
  }

  // 5) 描画ループ
  function loop(){
    requestAnimationFrame(loop);
    if(train){
      // ここでアニメさせてもいい
    }
    renderer.render(scene, camera);
  }
  loop();

  // 6) リサイズ
  window.addEventListener('resize', ()=>{
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
  });
}

// 画面に収める
function autoFit(model, camera, renderer, margin=0.9){
  const THREE = window.THREE || null; // 動的importなので念のため
  // ここで THREE がないことはほぼないが安全のため
  if (!renderer || !camera) return;
  const box = new (await import('https://unpkg.com/three@0.159.0/build/three.module.js')).Box3().setFromObject(model);
}

// シンプル版 autoFit（上のを簡単にしたもの）
function autoFitSimple(model, camera, renderer, margin=0.9){
  const box = new THREE.Box3().setFromObject(model);
  const size = new THREE.Vector3();
  box.getSize(size);
  const center = new THREE.Vector3();
  box.getCenter(center);
  model.position.sub(center);

  const dist = 2;
  camera.position.set(0,0,dist);
  camera.lookAt(0,0,0);

  const fov = camera.fov * (Math.PI/180);
  const visibleHeight = 2 * Math.tan(fov/2) * dist;
  const scale = (visibleHeight * margin) / size.y;
  model.scale.set(scale, scale, scale);
}

// 上の autoFit がちょっと長くなったのでこちらを実際に使う
function autoFit(model, camera, renderer, margin=0.9){
  const box = new THREE.Box3().setFromObject(model);
  const size = new THREE.Vector3();
  box.getSize(size);
  const center = new THREE.Vector3();
  box.getCenter(center);
  model.position.sub(center);

  const dist = 2;
  camera.position.set(0,0,dist);
  camera.lookAt(0,0,0);

  const fov = camera.fov * (Math.PI/180);
  const visibleHeight = 2 * Math.tan(fov/2) * dist;
  const scale = (visibleHeight * margin) / size.y;
  model.scale.set(scale, scale, scale);
}

function setStatus(text){
  statusEl.textContent = text;
  console.log(text);
}
</script>
</body>
</html>
